<!DOCTYPE html>
<html lang="en">
	<head>
		<title>lightyear.fm</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>

			body {
				background:#000;
				color: #eee;
				padding:0;
				margin:0;
				font-weight:bold;
				overflow:hidden;

				font-family:Monospace;
				font-size:13px;
				text-align:center;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
				z-index:10;
			}

			a {	color: #0080ff }
			b { color:orange }

			#distance {
			  position: absolute;
			  width:100%;
			  height:30px;
			  bottom:0px;
			  color:#fff;
				z-index: 10;
			}
			#button_reset {
				position: absolute;
				bottom:10px;
				left: 20px;
				padding: 4px;
				color: #fff;
				background-color: #555;
				opacity: 0.5;
				z-index: 100;
			}
			#button_reset:hover {
				cursor: pointer;
				opacity: 1;
			}
			#gui {
				position: absolute;
			  height:30px;
			  top:0px;
				right:0px;
				z-index: 100;
			}
			#slider-vertical {
				position: absolute;
				height: 100%;
				opacity: 0.5;
				z-index: 100;

			}

		</style>

		<!--link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css"-->
		<link rel="stylesheet" href="styles/jquery-ui.css">

		<script src="//code.jquery.com/jquery-1.10.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>


		<script src="../build/three.min.js"></script>

		<script src="js/controls/FlyControls.js"></script>
		<script src="js/controls/OrbitControls.js"></script>

		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/shaders/FilmShader.js"></script>
		<script src="js/shaders/FresnelShader.js"></script>
		<script src="js/shaders/FXAAShader.js"></script>

		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/FilmPass.js"></script>
		<script src="js/postprocessing/BokehPass.js"></script>
		<script src="js/postprocessing/BloomPass.js"></script>

		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>
		<script src="js/loaders/DDSLoader.js"></script>
		<script src="js/shaders/NormalDisplacementShader.js"></script>
		<!--script src="data/gaussian.js"></script-->
		<script src="data/random-0.26.js"></script>
		<script src="data/stars_named.json.js"></script>
		<!--script src="data/stars_all.json.js"></script-->

		<!---- LY scripts ---->
		<script src="helper.js"></script>
		<script src="settings.js"></script>
		<script src="starFX.js"></script>

		<script src="skybox.js"></script>
		<script src="solar_system.js"></script>
		<script src="stars.js"></script>
		<script src="named_stars.js"></script>
		<script src="asteroids.js"></script>
		<script src="nebulas.js"></script>

		<script src="http://:www.projects.mikelacher.com/lightyear/audioplayer/tracks.js"></script>
		<script src="http://:www.projects.mikelacher.com/lightyear/audioplayer/audio.js"></script>

		<script>
		// slider for fast navigation
		$(function() {
				$( "#slider-vertical" ).slider({
					orientation: "vertical",
					range: "min",
					min: 0,
					max: 1000,
					value: 0,
					slide: function( event, ui ) {
						setZoomLevel( ui.value );
					}
				});

			});
		</script>

	</head>

	<body oncontextmenu="return false;">





		<!---- UI ---->
		<div id="info"> lightyear.fm </div>

		<div id="gui"></div>

		<div id="button_reset" >Reset camera</div>
  	<div id="distance"></div>
		<div id="slider-vertical"></div>



		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var SCREEN_HEIGHT = window.innerHeight;
			var SCREEN_WIDTH  = window.innerWidth;

			var container, stats;
			var camera, controls, scene, sceneCube, renderer, composer, dpr;

			var usePostprocessing = true;

			var effectFXAA;

			var clock = new THREE.Clock();
			var delta;

		  var mouse = { x: 0, y: 0 }, mouseOnDown = { x: 0, y: 0 };

			// camera initial settings
		  var rotation = { x: 0.0, y: 0.0 },
			  	target = { x: 0.0, y: 0.0 },
			  	targetOnDown = { x: 0, y: 0 };

		  var distance = initialCameraDistance,
					distanceTarget = initialCameraDistance,
					realDistanceKM;

			var curZoomSpeed = 0, curZoomStep = zoomSteps[0];

			var OutDistance, ResetButton;					// UI

			var gui, cam;

			var audioPlayer, distanceMonitor;

			//init();
			//animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				OutDistance = document.getElementById('distance');
				ResetButton = document.getElementById('button_reset');

				ResetButton.addEventListener( 'click', function ( event ) {
					//distance = initialCameraDistance;
					distanceTarget -= distance - initialCameraDistance;
				}, false );

				camera = new THREE.PerspectiveCamera( initialCameraFOV, SCREEN_WIDTH / SCREEN_HEIGHT, 10000, 1e12 );
				//camera.position.z = 63000;

				scene = new THREE.Scene();
				//scene.fog = new THREE.FogExp2( 0x555555, 0.000000025 );

				//controls = new THREE.FlyControls( camera );
				//controls = new THREE.OrbitControls( camera );
				//controls.minDistance = 1;
				//controls.maxDistance = 5e12;

				//controls.movementSpeed = 1000;
				//controls.domElement = container;
				//controls.rollSpeed = 0; //Math.PI / 240;
				//controls.autoForward = false;
				//controls.dragToLook = true;

				// retina displays fix
				dpr = 1;
				if (window.devicePixelRatio !== undefined) {
				  dpr = window.devicePixelRatio;
				}

				if (debug) console.log("dpr: " + dpr);

				if (usePostprocessing){
								renderer = new THREE.WebGLRenderer( { antialias: false , alpha: true } );
				}else{
								renderer = new THREE.WebGLRenderer( { antialias: true , alpha: true } );
				}

				renderer.setPixelRatio( dpr );
				renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
				//renderer.setViewport( 0, 0, SCREEN_WIDTH * 1, SCREEN_HEIGHT * 1 );

				//renderer.sortObjects = false;
				//renderer.setFaceCulling( THREE.CullFaceNone );

				if (debug) console.log( "renderer MaxAnisotropy: " + renderer.getMaxAnisotropy() );

				if (usePostprocessing){

								renderer.gammaInput = false;
								renderer.gammaOutput = false;
								renderer.autoClear = false;
				}
				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.left = '20px';
				stats.domElement.style.zIndex = 5;
				container.appendChild( stats.domElement );


				// postprocessing

				if (usePostprocessing){

								var scenePass = new THREE.RenderPass( scene, camera );
								scenePass.clear = true;

								var effectFilm = new THREE.FilmPass( 0.1, 0.1, 2048, false );
								effectFXAA = new THREE.ShaderPass( THREE.FXAAShader );

								//var effectBokeh = new THREE.ShaderPass( THREE.BokehPass );

								effectFXAA.uniforms[ 'resolution' ].value.set( 1 / SCREEN_WIDTH, 1 / SCREEN_HEIGHT);
								//effectFXAA.uniforms[ 'resolution' ].value.set( 1 / SCREEN_WIDTH * dpr, 1 / SCREEN_HEIGHT * dpr);

								effectFilm.renderToScreen = true;
								//effectFXAA.renderToScreen = true;

								var parameters = { minFilter: THREE.LinearFilter,
									magFilter: THREE.LinearFilter,
									format: THREE.RGBAFormat,
									stencilBuffer: true };

								var renderTarget = new THREE.WebGLRenderTarget( SCREEN_WIDTH , SCREEN_HEIGHT , parameters );

								composer = new THREE.EffectComposer( renderer, renderTarget );
								//composer = new THREE.EffectComposer( renderer );
								//composer.setSize(SCREEN_WIDTH *2, SCREEN_HEIGHT *2 );


								composer.addPass( scenePass );

								composer.addPass( effectFXAA );  //final pass
								composer.addPass( effectFilm );
				}

				//initSkyBoxCube();
				//initSkyBoxEquirec();
				//initSkyBoxProcedural();

				initSolarSystem();
				//initStars();
				initNamedStars();
				initAsteroids();
				initNebulaClouds();
				initSkyBoxSimple();


				//Events

				window.addEventListener( 'resize', onWindowResize, false );

				container.addEventListener('mousedown', onMouseDown, false);
				container.addEventListener('mousewheel', onMouseWheel, false);

				document.addEventListener('keydown', onDocumentKeyDown, false);
				document.addEventListener('keyup', onDocumentKeyUp, false);

				container.addEventListener('mouseover', function() {
					overRenderer = true;
				}, false);

				container.addEventListener('mouseout', function() {
				  overRenderer = false;
				}, false);


				if (debug) {

					cam = new camDebug();
					debug_zoom  = new debug_curZoomStep();
					initGUI();

				}

				console.log("Init done");
			};


			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

				realDistanceKM = Math.round(distance) / global.DistanceScale;

				if (curZoomStep.id > 3) realDistanceKM /= global.starsDistanceScale;

				//OutDistance.innerHTML = "Distance from Earth: " + camera.position.distanceTo(earthPos);
				OutDistance.innerHTML = "Distance from Earth: " + realDistanceKM + " km   /   "
																+ kmToLY(realDistanceKM).toPrecision(3) + " light years";

			};

			function render() {

				updateCamera();

				delta = clock.getDelta();

				renderSkybox();
				renderSolarSystem();
				starsUpdate();
				asteroidsUpdate();
				NebulaCloudsUpdate();

				//controls.movementSpeed = 0.33 * d;
				//controls.update( delta );

				if (usePostprocessing){
								renderer.clear();
								composer.render( delta );
				}else{
								renderer.render( scene, camera );
				}

			};


			function updateCamera(){

				////if (distance - delta > minCameraDistance && distance + delta < maxCameraDistance){
				//if (distance + (distanceTarget - distance) * 0.3> minCameraDistance && distance  < maxCameraDistance)
				{
					zoom(curZoomSpeed);

					rotation.x += (target.x - rotation.x) * 0.1;
					rotation.y += (target.y - rotation.y) * 0.1;

					distance += (distanceTarget - distance) * cameraZoomDamp;

				}

				camera.position.x = distance * Math.sin(rotation.x) * Math.cos(rotation.y);
				camera.position.y = distance * Math.sin(rotation.y);
				camera.position.z = distance * Math.cos(rotation.x) * Math.cos(rotation.y);

				//target.x = 0.2 - ( 1 - initialCameraDistance / distance )/10;

				cam.x = camera.position.x; cam.y = camera.position.y; cam.z = camera.position.z;

				//var speedAccel = Math.pow(distance / initialCameraDistance, 1);
				//var speedAccel = Math.sqrt(distance / initialCameraDistance);
				//zoomSpeed += speedAccel;
				//fastZoomSpeed += speedAccel;
				//wheelZoomStep += speedAccel/10;

				for (var i=1; i < zoomSteps.length; i++){
					if ( distance < zoomSteps[i].border * global.DistanceScale
							 && distance > zoomSteps[i-1].border * global.DistanceScale ) {

						curZoomStep = zoomSteps[i];
						debug_zoom.zoom_factor = curZoomStep.zoom_factor;
						//wheelZoomStep = 300 * , fastWheelZoomStep = wheelZoomStep * 20;
					}
				}

				camera.lookAt( new THREE.Vector3( earthPos.x, earthPos.y, earthPos.z ));

			};


			function initAudio(){

				//audioPlayer = new AudioPlayer(tracks, remainingTimeToBuffer, remainingTimeToCrossfade);
				//distanceMonitor = new DistanceMonitor(audioPlayer.playYear);

			}

			function updateAudio(){

				//then whenever the distance from earth changes, call this:
				//distanceMonitor.setDistance( kmToLY( distance ) );

			}

			if (debug){
				var fileSelector = document.createElement('input');
				fileSelector.setAttribute('type', 'file');
				fileSelector.onchange = updateBGtexture;

				var loadBG = { loadBG: function(){
					fileSelector.click();
	        }
	      };
				function updateBGtexture(event){

					var objectURL = window.URL.createObjectURL(fileSelector.files[0]);
					console.log(objectURL);
					initSkyBoxSimple( objectURL );
				}

			}


			// debug gui
			function initGUI(){

				gui = new dat.GUI( { autoPlace: false } );
				var guiContainer = document.getElementById('gui');
			  guiContainer.appendChild(gui.domElement);
				//gui.add(global, 'DistanceScale').min(0.001).max(1.0).step(0.01);
				gui.add(cam, 'x').listen();
				gui.add(cam, 'y').listen();
				gui.add(cam, 'z').listen();

				gui.add(debug_zoom, 'zoom_factor').listen();

				gui.add(this, 'ambientLightIntensity', 0, 1.0).onFinishChange(function(value) {
					ambientLightIntensity = value;
					hemiLight.intensity = value;
				});;

				gui.add(loadBG, 'loadBG');

				// gui.add(renderer, 'gammaInput').onChange(function(value) {
				// 	alert(value);
				// 	renderer.gammaInput = value;
				// });
			}


			//Event handlers

			window.onload = function(){

					if ( GET.use_pp === 'true' ) usePostprocessing = true
					else usePostprocessing = false;
console.log(GET.dist);
					if ( GET.dist != undefined ) {

						distanceTarget = lyToKM(GET.dist) * global.DistanceScale * global.starsDistanceScale;
						console.log(distanceTarget);

					}


					init();
					animate();

			}

			function onWindowResize( event ) {

				SCREEN_HEIGHT = window.innerHeight;
				SCREEN_WIDTH  = window.innerWidth;


				effectFXAA.uniforms[ 'resolution' ].value.set( 1 / SCREEN_WIDTH , 1 / SCREEN_HEIGHT );

				renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
				composer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

				solarSystemResize();
				skyboxResize();

				camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
				camera.updateProjectionMatrix();

				composer.reset();

			};

			function onMouseDown(event) {
				event.preventDefault();

				container.addEventListener('mousemove', onMouseMove, false);
				container.addEventListener('mouseup', onMouseUp, false);
				container.addEventListener('mouseout', onMouseOut, false);

				mouseOnDown.x = - event.clientX;
				mouseOnDown.y = event.clientY;

				targetOnDown.x = target.x;
				targetOnDown.y = target.y;

				container.style.cursor = 'move';

				switch ( event.button ) {

					case 0: fastZoom ? curZoomSpeed = fastZoomSpeed * curZoomStep.zoom_factor : curZoomSpeed = zoomSpeed * curZoomStep.zoom_factor;
						break;
					case 2: fastZoom ? curZoomSpeed = -fastZoomSpeed * curZoomStep.zoom_factor: curZoomSpeed = -zoomSpeed * curZoomStep.zoom_factor;
						break;

				}

			}

			function onMouseMove(event) {
				mouse.x = - event.clientX;
				mouse.y = event.clientY;

				if (allowCameraLookAround){

					var zoomDamp = 0.6;

					target.x = targetOnDown.x + (mouse.x - mouseOnDown.x) * 0.0005 * zoomDamp;
					target.y = targetOnDown.y + (mouse.y - mouseOnDown.y) * 0.0005 * zoomDamp;

					////target.y = target.y > PI_HALF ? PI_HALF : target.y;
					////target.y = target.y < - PI_HALF ? - PI_HALF : target.y;

				}

			}

			function onMouseUp(event) {
				container.removeEventListener('mousemove', onMouseMove, false);
				container.removeEventListener('mouseup', onMouseUp, false);
				container.removeEventListener('mouseout', onMouseOut, false);
				container.style.cursor = 'auto';
				curZoomSpeed = 0;
			}

			function onMouseOut(event) {
				container.removeEventListener('mousemove', onMouseMove, false);
				container.removeEventListener('mouseup', onMouseUp, false);
				container.removeEventListener('mouseout', onMouseOut, false);
			}

			function onMouseWheel(event) {
				event.preventDefault();

				var zoomStep = wheelZoomStep;

				fastZoom ? zoomStep = fastWheelZoomStep * curZoomStep.zoom_factor : zoomStep = wheelZoomStep * curZoomStep.zoom_factor;
				zoom( event.wheelDeltaY * zoomStep );

				//curZoomSpeed = event.wheelDeltaY * curZoomStep.zoom_factor;

				return false;
			}

			function zoom(delta) {

			//	if (distance - delta > minCameraDistance && distance + delta < maxCameraDistance){
					distanceTarget -= delta;
			//	}
				//distanceTarget = distanceTarget > 1000 ? 1000 : distanceTarget;
				//distanceTarget = distanceTarget < 350 ? 350 : distanceTarget;
			}

			function setZoomLevel( ui_value ){  // handler for slider zoom

				var span = maxCameraDistance;


				if ( ui_value < 250 ){

					distanceTarget = ui_value * span / 1000 + initialCameraDistance;

				}
				else{

					distanceTarget = ui_value * span / 1000 + initialCameraDistance;

				}

			}

			function onDocumentKeyDown(event) {
				//alert(event.keyCode);
				switch (event.keyCode) {
					case 38:
						zoom(100);
						event.preventDefault();
						break;
					case 40:
						zoom(-100);
						event.preventDefault();
						break;
					case 17:                  // Ctrl key
						fastZoom = true;
						event.preventDefault();
						break;
				}
			}
			function onDocumentKeyUp(event) {
				//alert(event.keyCode);
				switch (event.keyCode) {
					case 17:
						fastZoom = false;
						event.preventDefault();
						break;
				}
			}

			//fetch url params
			var GET = {};
			var query = window.location.search.substring(1).split("&");
			for (var i = 0;  i < 3; i++)	{
    		if (query[i] === "" || query[i] == undefined) // check for trailing & with no param
        	continue;

    		var param = query[i].split("=");
    		GET[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
			}


		</script>
	</body>
</html>
